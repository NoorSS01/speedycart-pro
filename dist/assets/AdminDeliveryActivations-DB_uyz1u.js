import{k as q,n as B,r as f,s as m,l as p,j as e,v as w,B as l,T as M,ai as L,F as E,a6 as U,x as v,y as g,U as Y,X as P,af as _,_ as H,$ as Q,Q as u}from"./index-Cg7UL77a.js";import{A as X}from"./AdminBottomNav-BHLz8l2e.js";import{P as R}from"./power-3m8zcK0M.js";import"./sheet-LPIwcTPd.js";import"./wallet-BcFujo2b.js";function Z(){const{user:c,userRole:S,loading:k}=q(),j=B(),[N,D]=f.useState([]),[T,b]=f.useState(!0),[d,x]=f.useState({open:!1,requestId:null,hours:8}),A=S==="admin"||S==="super_admin";f.useEffect(()=>{if(!k){if(!c||!A){j("/");return}y()}},[c,k,A,j]);const y=async()=>{try{const s=new Date().toISOString().split("T")[0],{data:t,error:a}=await m.from("delivery_activations").select("*").eq("activation_date",s).order("created_at",{ascending:!1});if(a){p.error("Failed to fetch activations",{error:a}),b(!1);return}if(!t||t.length===0){D([]),b(!1);return}const r=[...new Set(t.map(i=>i.delivery_partner_id))],{data:n}=await m.from("profiles").select("id, full_name, phone").in("id",r),o=new Map((n||[]).map(i=>[i.id,{full_name:i.full_name,phone:i.phone}])),O=t.map(i=>({id:i.id,delivery_partner_id:i.delivery_partner_id,activation_date:i.activation_date,status:i.status||"pending",created_at:i.created_at||new Date().toISOString(),approved_until:i.approved_until||null,duration_hours:i.duration_hours||null,profiles:o.get(i.delivery_partner_id)||null}));D(O)}catch(s){p.error("Failed to fetch delivery activation requests",{error:s})}b(!1)},C=async(s,t,a)=>{try{const r={status:t,admin_id:c==null?void 0:c.id,updated_at:new Date().toISOString()};if(t==="approved"&&a){const o=new Date;o.setHours(o.getHours()+a),r.approved_until=o.toISOString(),r.duration_hours=a}const{error:n}=await m.from("delivery_activations").update(r).eq("id",s);if(n){p.error("Failed to update activation status",{error:n,id:s,status:t}),u.error(`Failed to update: ${n.message}`);return}u.success(`Request ${t}${t==="approved"?` for ${a}h`:""}`),x({open:!1,requestId:null,hours:8}),y()}catch(r){p.error("Error updating activation status",{error:r}),u.error("Failed to update request")}},$=s=>{x({open:!0,requestId:s,hours:8})},z=async s=>{try{const t=N.find(a=>a.id===s);if(await m.from("delivery_activations").update({status:"rejected",approved_until:null,updated_at:new Date().toISOString()}).eq("id",s),t!=null&&t.delivery_partner_id)try{await m.from("notifications").insert({user_id:t.delivery_partner_id,type:"activation_stopped",title:"Activation Stopped",message:"Your delivery activation has been stopped by admin. You will not receive new orders.",read:!1,created_at:new Date().toISOString()})}catch(a){p.warn("Could not send notification to delivery partner",{error:a})}u.success("Activation stopped"),y()}catch{u.error("Failed to stop activation")}},F=s=>{if(!s)return null;const t=new Date(s),a=new Date,r=t.getTime()-a.getTime();if(r<=0)return"Expired";const n=Math.floor(r/(1e3*60*60)),o=Math.floor(r%(1e3*60*60)/(1e3*60));return`${n}h ${o}m left`};if(T)return e.jsxs("div",{className:"min-h-screen bg-background pb-20",children:[e.jsx("header",{className:"sticky top-0 z-40 border-b bg-background/95 backdrop-blur",children:e.jsxs("div",{className:"container mx-auto px-4 py-4 flex items-center gap-3",children:[e.jsx(w,{className:"h-8 w-8"}),e.jsx(w,{className:"h-6 w-48"})]})}),e.jsx("div",{className:"container mx-auto px-4 py-6 space-y-4",children:[1,2,3].map(s=>e.jsx(w,{className:"h-24 rounded-xl"},s))})]});const h=N.filter(s=>s.status==="pending"),I=N.filter(s=>s.status!=="pending");return e.jsxs("div",{className:"min-h-screen bg-background pb-20",children:[e.jsx("header",{className:"sticky top-0 z-40 border-b bg-background/95 backdrop-blur",children:e.jsxs("div",{className:"container mx-auto px-4 py-4 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(l,{variant:"ghost",size:"icon",onClick:()=>j("/admin"),children:e.jsx(M,{className:"h-5 w-5"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-lg font-bold",children:"Delivery Activations"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Today - ",L(new Date,"PPP")]})]})]}),e.jsxs(E,{variant:"outline",className:"flex items-center gap-1",children:[e.jsx(U,{className:"h-3 w-3"}),h.length," pending"]})]})}),e.jsxs("div",{className:"container mx-auto px-4 py-6 space-y-6",children:[h.length>0&&e.jsxs("div",{children:[e.jsxs("h2",{className:"font-semibold mb-3 flex items-center gap-2",children:[e.jsx(R,{className:"h-4 w-4 text-amber-500"}),"Pending Requests"]}),e.jsx("div",{className:"space-y-3",children:h.map(s=>{var t,a;return e.jsx(v,{className:"border-amber-500/50",children:e.jsx(g,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-amber-500/10 flex items-center justify-center",children:e.jsx(Y,{className:"h-5 w-5 text-amber-500"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:((t=s.profiles)==null?void 0:t.full_name)||"Delivery Partner"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:((a=s.profiles)==null?void 0:a.phone)||"No phone"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(l,{size:"sm",variant:"outline",className:"text-red-500 border-red-500 hover:bg-red-500 hover:text-white",onClick:()=>C(s.id,"rejected"),children:e.jsx(P,{className:"h-4 w-4"})}),e.jsxs(l,{size:"sm",className:"bg-green-500 hover:bg-green-600",onClick:()=>$(s.id),children:[e.jsx(_,{className:"h-4 w-4 mr-1"}),"Approve"]})]})]})})},s.id)})})]}),h.length===0&&e.jsx(v,{children:e.jsxs(g,{className:"py-12 text-center",children:[e.jsx(R,{className:"h-12 w-12 mx-auto mb-4 text-muted-foreground opacity-50"}),e.jsx("p",{className:"text-muted-foreground",children:"No pending activation requests"})]})}),I.length>0&&e.jsxs("div",{children:[e.jsx("h2",{className:"font-semibold mb-3 text-sm text-muted-foreground",children:"Processed Today"}),e.jsx("div",{className:"space-y-2",children:I.map(s=>{var r;const t=s.status==="approved"?F(s.approved_until):null,a=t&&t!=="Expired";return e.jsx(v,{className:a?"border-green-500":"opacity-75",children:e.jsx(g,{className:"p-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center ${s.status==="approved"?"bg-green-500":"bg-red-500"}`,children:s.status==="approved"?e.jsx(_,{className:"h-4 w-4 text-white"}):e.jsx(P,{className:"h-4 w-4 text-white"})}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm font-medium",children:((r=s.profiles)==null?void 0:r.full_name)||"Partner"}),t&&e.jsx("p",{className:`text-xs ${t==="Expired"?"text-red-500":"text-green-600"}`,children:t})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[a&&e.jsx(l,{size:"sm",variant:"outline",className:"text-red-500 border-red-500 hover:bg-red-50 h-7",onClick:()=>z(s.id),children:"Stop"}),e.jsx(E,{variant:s.status==="approved"?a?"default":"secondary":"destructive",children:a?"Active":s.status})]})]})})},s.id)})})]})]}),d.open&&e.jsx("div",{className:"fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4",children:e.jsxs(v,{className:"w-full max-w-sm",children:[e.jsx(H,{children:e.jsx(Q,{className:"text-lg",children:"Set Activation Duration"})}),e.jsxs(g,{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"How long should this activation be valid?"}),e.jsx("div",{className:"grid grid-cols-4 gap-2",children:[4,6,8,10,12,16,20,24].map(s=>e.jsxs(l,{variant:d.hours===s?"default":"outline",size:"sm",onClick:()=>x(t=>({...t,hours:s})),children:[s,"h"]},s))}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(l,{variant:"outline",className:"flex-1",onClick:()=>x({open:!1,requestId:null,hours:8}),children:"Cancel"}),e.jsxs(l,{className:"flex-1 bg-green-500 hover:bg-green-600",onClick:()=>d.requestId&&C(d.requestId,"approved",d.hours),children:[e.jsx(_,{className:"h-4 w-4 mr-1"}),"Approve for ",d.hours,"h"]})]})]})]})}),e.jsx(X,{})]})}export{Z as default};
