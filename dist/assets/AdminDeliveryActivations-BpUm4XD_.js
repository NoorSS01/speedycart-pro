import{u as O,a as B,r as p,s as u,l as I,j as e,S as b,B as l,A as M,h as L,i as z,z as U,C as x,c as h,U as H,ad as P,ai as y,E as X,F as G,n as f}from"./index-DuGsTUiO.js";import{A as J}from"./AdminBottomNav-BrCgukUx.js";import{P as R}from"./power-CQy0ZWtZ.js";import"./wallet-BxhHC8Lj.js";function Y(){const{user:d,userRole:w,loading:_}=O(),v=B(),[k,D]=p.useState([]),[E,g]=p.useState(!0),[c,o]=p.useState({open:!1,requestId:null,hours:8}),S=w==="admin"||w==="super_admin";p.useEffect(()=>{if(!_){if(!d||!S){v("/");return}j()}},[d,_,S,v]);const j=async()=>{try{const s=new Date().toISOString().split("T")[0],{data:t,error:a}=await u.from("delivery_activations").select("id, delivery_partner_id, activation_date, status, created_at").eq("activation_date",s).order("created_at",{ascending:!1});if(a){I.error("Failed to fetch activations",{error:a}),g(!1);return}if(!t||t.length===0){D([]),g(!1);return}const i=[...new Set(t.map(r=>r.delivery_partner_id))],{data:n}=await u.from("profiles").select("id, full_name, phone").in("id",i),N=new Map((n||[]).map(r=>[r.id,{full_name:r.full_name,phone:r.phone}])),F=t.map(r=>({id:r.id,delivery_partner_id:r.delivery_partner_id,activation_date:r.activation_date,status:r.status||"pending",created_at:r.created_at||new Date().toISOString(),approved_until:r.approved_until||null,duration_hours:r.duration_hours||null,profiles:N.get(r.delivery_partner_id)||null}));D(F)}catch(s){I.error("Failed to fetch delivery activation requests",{error:s})}g(!1)},A=async(s,t,a)=>{try{const i={status:t,admin_id:d==null?void 0:d.id,updated_at:new Date().toISOString()};if(t==="approved"&&a){const n=new Date;n.setHours(n.getHours()+a),i.approved_until=n.toISOString(),i.duration_hours=a}await u.from("delivery_activations").update(i).eq("id",s),f.success(`Request ${t}${t==="approved"?` for ${a}h`:""}`),o({open:!1,requestId:null,hours:8}),j()}catch{f.error("Failed to update request")}},T=s=>{o({open:!0,requestId:s,hours:8})},$=async s=>{try{await u.from("delivery_activations").update({status:"rejected",approved_until:null,updated_at:new Date().toISOString()}).eq("id",s),f.success("Activation stopped"),j()}catch{f.error("Failed to stop activation")}},q=s=>{if(!s)return null;const t=new Date(s),a=new Date,i=t.getTime()-a.getTime();if(i<=0)return"Expired";const n=Math.floor(i/(1e3*60*60)),N=Math.floor(i%(1e3*60*60)/(1e3*60));return`${n}h ${N}m left`};if(E)return e.jsxs("div",{className:"min-h-screen bg-background pb-20",children:[e.jsx("header",{className:"sticky top-0 z-40 border-b bg-background/95 backdrop-blur",children:e.jsxs("div",{className:"container mx-auto px-4 py-4 flex items-center gap-3",children:[e.jsx(b,{className:"h-8 w-8"}),e.jsx(b,{className:"h-6 w-48"})]})}),e.jsx("div",{className:"container mx-auto px-4 py-6 space-y-4",children:[1,2,3].map(s=>e.jsx(b,{className:"h-24 rounded-xl"},s))})]});const m=k.filter(s=>s.status==="pending"),C=k.filter(s=>s.status!=="pending");return e.jsxs("div",{className:"min-h-screen bg-background pb-20",children:[e.jsx("header",{className:"sticky top-0 z-40 border-b bg-background/95 backdrop-blur",children:e.jsxs("div",{className:"container mx-auto px-4 py-4 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(l,{variant:"ghost",size:"icon",onClick:()=>v("/admin"),children:e.jsx(M,{className:"h-5 w-5"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-lg font-bold",children:"Delivery Activations"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Today - ",L(new Date,"PPP")]})]})]}),e.jsxs(z,{variant:"outline",className:"flex items-center gap-1",children:[e.jsx(U,{className:"h-3 w-3"}),m.length," pending"]})]})}),e.jsxs("div",{className:"container mx-auto px-4 py-6 space-y-6",children:[m.length>0&&e.jsxs("div",{children:[e.jsxs("h2",{className:"font-semibold mb-3 flex items-center gap-2",children:[e.jsx(R,{className:"h-4 w-4 text-amber-500"}),"Pending Requests"]}),e.jsx("div",{className:"space-y-3",children:m.map(s=>{var t,a;return e.jsx(x,{className:"border-amber-500/50",children:e.jsx(h,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-amber-500/10 flex items-center justify-center",children:e.jsx(H,{className:"h-5 w-5 text-amber-500"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:((t=s.profiles)==null?void 0:t.full_name)||"Delivery Partner"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:((a=s.profiles)==null?void 0:a.phone)||"No phone"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(l,{size:"sm",variant:"outline",className:"text-red-500 border-red-500 hover:bg-red-500 hover:text-white",onClick:()=>A(s.id,"rejected"),children:e.jsx(P,{className:"h-4 w-4"})}),e.jsxs(l,{size:"sm",className:"bg-green-500 hover:bg-green-600",onClick:()=>T(s.id),children:[e.jsx(y,{className:"h-4 w-4 mr-1"}),"Approve"]})]})]})})},s.id)})})]}),m.length===0&&e.jsx(x,{children:e.jsxs(h,{className:"py-12 text-center",children:[e.jsx(R,{className:"h-12 w-12 mx-auto mb-4 text-muted-foreground opacity-50"}),e.jsx("p",{className:"text-muted-foreground",children:"No pending activation requests"})]})}),C.length>0&&e.jsxs("div",{children:[e.jsx("h2",{className:"font-semibold mb-3 text-sm text-muted-foreground",children:"Processed Today"}),e.jsx("div",{className:"space-y-2",children:C.map(s=>{var i;const t=s.status==="approved"?q(s.approved_until):null,a=t&&t!=="Expired";return e.jsx(x,{className:a?"border-green-500":"opacity-75",children:e.jsx(h,{className:"p-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center ${s.status==="approved"?"bg-green-500":"bg-red-500"}`,children:s.status==="approved"?e.jsx(y,{className:"h-4 w-4 text-white"}):e.jsx(P,{className:"h-4 w-4 text-white"})}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm font-medium",children:((i=s.profiles)==null?void 0:i.full_name)||"Partner"}),t&&e.jsx("p",{className:`text-xs ${t==="Expired"?"text-red-500":"text-green-600"}`,children:t})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[a&&e.jsx(l,{size:"sm",variant:"outline",className:"text-red-500 border-red-500 hover:bg-red-50 h-7",onClick:()=>$(s.id),children:"Stop"}),e.jsx(z,{variant:s.status==="approved"?a?"default":"secondary":"destructive",children:a?"Active":s.status})]})]})})},s.id)})})]})]}),c.open&&e.jsx("div",{className:"fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4",children:e.jsxs(x,{className:"w-full max-w-sm",children:[e.jsx(X,{children:e.jsx(G,{className:"text-lg",children:"Set Activation Duration"})}),e.jsxs(h,{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"How long should this activation be valid?"}),e.jsx("div",{className:"grid grid-cols-4 gap-2",children:[4,6,8,10,12,16,20,24].map(s=>e.jsxs(l,{variant:c.hours===s?"default":"outline",size:"sm",onClick:()=>o(t=>({...t,hours:s})),children:[s,"h"]},s))}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(l,{variant:"outline",className:"flex-1",onClick:()=>o({open:!1,requestId:null,hours:8}),children:"Cancel"}),e.jsxs(l,{className:"flex-1 bg-green-500 hover:bg-green-600",onClick:()=>c.requestId&&A(c.requestId,"approved",c.hours),children:[e.jsx(y,{className:"h-4 w-4 mr-1"}),"Approve for ",c.hours,"h"]})]})]})]})}),e.jsx(J,{})]})}export{Y as default};
