import{u as V,a as W,i as X,r as c,b as Y,s as m,h as Z,k as ee,l as se,j as e,S as A,B as ae,A as te,f as E,C as u,c as p,e as re,x as v,y,T as ne,U as de,M as ie,P as le,d as ce}from"./index-BHemtGSZ.js";import{T as oe}from"./timer-B1CW4wsS.js";function ue(){const{user:D,userRole:w,loading:T}=V(),_=W(),{orderId:i}=X(),[t,I]=c.useState(null),[k,$]=c.useState([]),[M,B]=c.useState({name:"Customer",phone:""}),[j,O]=c.useState(null),[d,L]=c.useState(null),[R,C]=c.useState(!0),[Q,U]=c.useState(new Date),{deliveryTimeMinutes:S}=Y();c.useEffect(()=>{const s=setInterval(()=>U(new Date),1e3);return()=>clearInterval(s)},[]),c.useEffect(()=>{if(!T){if(!D){_("/auth");return}if(w!=="admin"&&w!=="super_admin"){_("/shop");return}i&&z()}},[D,w,T,i]);const z=async()=>{if(i){C(!0);try{const{data:s}=await m.from("orders").select("*").eq("id",i).single();if(!s){Z.error("Order not found"),_("/admin/orders");return}I(s);const{data:r}=await m.from("order_items").select("id, quantity, price, product_id, variant_id").eq("order_id",i);if(r&&r.length>0){const x=r.map(a=>a.product_id),{data:l}=await m.from("products").select("id, name, image_url, unit").in("id",x),h=r.map(a=>a.variant_id).filter(Boolean);let f=new Map;if(h.length>0){const{data:a}=await m.from("product_variants").select("id, variant_name, variant_value, variant_unit").in("id",h);f=new Map((a||[]).map(N=>[N.id,N]))}const g=new Map((l||[]).map(a=>[a.id,a]));$(r.map(a=>{var q,P;const N=f.get(a.variant_id),J=(q=g.get(a.product_id))==null?void 0:q.unit,K=ee(a.quantity,N||null,J);return{...a,name:((P=g.get(a.product_id))==null?void 0:P.name)||"Product",calculatedQty:K}}))}const{data:b}=await m.from("profiles").select("full_name, phone").eq("id",s.user_id).single();b&&B({name:b.full_name||"Customer",phone:b.phone||""});const{data:n}=await m.from("delivery_assignments").select("id, delivery_person_id, marked_delivered_at, user_confirmed_at, assigned_at").eq("order_id",i).single();if(n&&(L(n),n.delivery_person_id)){const{data:x}=await m.from("profiles").select("full_name, phone").eq("id",n.delivery_person_id).single();if(x){const{data:l}=await m.from("delivery_ratings").select("rating").eq("delivery_person_id",n.delivery_person_id),h=l&&l.length>0?Math.round(l.reduce((f,g)=>f+g.rating,0)/l.length*10)/10:0;O({name:x.full_name||"Delivery Partner",phone:x.phone||"",rating:h})}}}catch(s){se.error("Failed to fetch admin order details",{error:s})}finally{C(!1)}}},o=s=>{const r=new Date(s),b=new Date(r.getTime()+S*60*1e3),n=Math.max(0,b.getTime()-Q.getTime()),x=S*60*1e3,l=n/x*100,h=Math.floor(n/6e4),f=Math.floor(n%6e4/1e3),g=n>0?`${h}:${f.toString().padStart(2,"0")}`:"0:00";let a;return l>50?a="green":l>25?a="yellow":a="red",{timeString:g,color:a,isExpired:n===0}},F=s=>{const r={pending:"bg-amber-500",confirmed:"bg-blue-500",out_for_delivery:"bg-purple-500",delivered:"bg-emerald-500",cancelled:"bg-red-500"};return e.jsx(ce,{className:r[s]||"bg-gray-500",children:s.replace(/_/g," ")})};if(R)return e.jsxs("div",{className:"min-h-screen bg-background p-4",children:[e.jsx(A,{className:"h-12 w-full mb-4"}),e.jsx(A,{className:"h-96 w-full rounded-xl"})]});if(!t)return e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:e.jsx("p",{className:"text-muted-foreground",children:"Order not found"})});const H=(d==null?void 0:d.user_confirmed_at)||t.status==="delivered",G=t.status==="out_for_delivery"&&!(d!=null&&d.marked_delivered_at);return e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-primary/5 via-background to-accent/5 pb-8",children:[e.jsx("header",{className:"sticky top-0 z-50 bg-background/80 backdrop-blur-xl border-b",children:e.jsxs("div",{className:"flex items-center gap-3 px-4 py-3",children:[e.jsx(ae,{variant:"ghost",size:"icon",onClick:()=>_("/admin/orders"),children:e.jsx(te,{className:"w-5 h-5"})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("h1",{className:"font-bold",children:["Order #",i==null?void 0:i.slice(0,8)]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:E(new Date(t.created_at),"dd MMM yyyy, hh:mm a")})]}),F(t.status)]})}),e.jsxs("div",{className:"p-4 space-y-4",children:[H?e.jsx(u,{className:"border-emerald-200 bg-emerald-50 dark:bg-emerald-900/20",children:e.jsxs(p,{className:"p-4 flex items-center gap-3",children:[e.jsx(re,{className:"w-8 h-8 text-emerald-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-bold text-emerald-700 dark:text-emerald-400",children:"Delivered"}),e.jsx("p",{className:"text-sm text-emerald-600 dark:text-emerald-300",children:d!=null&&d.user_confirmed_at?E(new Date(d.user_confirmed_at),"dd MMM, hh:mm a"):"Confirmed"})]})]})}):G?e.jsx(u,{className:`border-2 ${o(t.created_at).color==="red"?"border-red-300 bg-red-50":o(t.created_at).color==="yellow"?"border-amber-300 bg-amber-50":"border-emerald-300 bg-emerald-50"}`,children:e.jsxs(p,{className:"p-4 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(oe,{className:`w-8 h-8 ${o(t.created_at).color==="red"?"text-red-500 animate-pulse":o(t.created_at).color==="yellow"?"text-amber-500":"text-emerald-500"}`}),e.jsxs("div",{children:[e.jsx("p",{className:"font-bold",children:"Delivery Timer"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Time remaining"})]})]}),e.jsx("p",{className:`text-3xl font-mono font-bold ${o(t.created_at).color==="red"?"text-red-600":o(t.created_at).color==="yellow"?"text-amber-600":"text-emerald-600"}`,children:o(t.created_at).isExpired?"LATE":o(t.created_at).timeString})]})}):null,j&&e.jsxs(u,{children:[e.jsx(v,{className:"pb-2",children:e.jsxs(y,{className:"text-sm flex items-center gap-2",children:[e.jsx(ne,{className:"w-4 h-4"}),"Delivery Partner"]})}),e.jsx(p,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:j.name}),e.jsx("p",{className:"text-sm text-muted-foreground",children:j.phone||"No phone"})]}),j.rating>0&&e.jsxs("div",{className:"flex items-center gap-1 text-amber-500 bg-amber-50 dark:bg-amber-900/20 px-2 py-1 rounded-lg",children:[e.jsx("span",{className:"text-lg",children:"⭐"}),e.jsx("span",{className:"font-bold",children:j.rating})]})]})})]}),e.jsxs(u,{children:[e.jsx(v,{className:"pb-2",children:e.jsxs(y,{className:"text-sm flex items-center gap-2",children:[e.jsx(de,{className:"w-4 h-4"}),"Customer"]})}),e.jsxs(p,{children:[e.jsx("p",{className:"font-medium",children:M.name}),e.jsx("p",{className:"text-sm text-muted-foreground",children:M.phone||"No phone"})]})]}),e.jsxs(u,{children:[e.jsx(v,{className:"pb-2",children:e.jsxs(y,{className:"text-sm flex items-center gap-2",children:[e.jsx(ie,{className:"w-4 h-4"}),"Delivery Address"]})}),e.jsx(p,{children:e.jsx("p",{className:"text-sm",children:t.delivery_address})})]}),e.jsxs(u,{children:[e.jsx(v,{className:"pb-2",children:e.jsxs(y,{className:"text-sm flex items-center gap-2",children:[e.jsx(le,{className:"w-4 h-4"}),"Items (",k.length,")"]})}),e.jsx(p,{className:"divide-y",children:k.map((s,r)=>e.jsxs("div",{className:"py-3",children:[e.jsxs("p",{className:"font-semibold text-base mb-1",children:[r+1,". ",s.name]}),e.jsxs("div",{className:"flex justify-between items-center bg-muted rounded-lg px-3 py-2",children:[e.jsxs("span",{className:"text-sm text-muted-foreground",children:[e.jsx("span",{className:"font-medium text-foreground",children:s.calculatedQty||`${s.quantity} ${s.unit}`})," @ ₹",s.price]}),e.jsxs("span",{className:"text-lg font-bold text-primary",children:["₹",s.quantity*s.price]})]})]},s.id))})]}),e.jsx(u,{className:"bg-primary/5",children:e.jsxs(p,{className:"p-4 flex justify-between items-center",children:[e.jsx("span",{className:"font-bold text-lg",children:"Total"}),e.jsxs("span",{className:"text-2xl font-bold text-primary",children:["₹",t.total_amount]})]})})]})]})}export{ue as default};
