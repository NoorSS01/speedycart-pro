import{u as G,a as J,o as K,r as n,s as r,n as v,l as P,p as W,j as e,S as E,B as x,A as X,C as Z,c as ee,h as se,M as ae,P as te,T as re,k as de}from"./index-DjVIGd9W.js";import{N as ie}from"./navigation-DqTuiCX1.js";function le(){const{user:N,loading:b}=G(),p=J(),{orderId:d}=K(),[s,L]=n.useState(null),[y,A]=n.useState([]),[c,T]=n.useState(null),[B,_]=n.useState(!0),[l,o]=n.useState(!1);n.useEffect(()=>{if(!b){if(!N){p("/auth");return}d&&h()}},[N,b,d]);const h=async()=>{if(d){_(!0);try{const{data:a}=await r.from("orders").select("*").eq("id",d).single();if(!a){v.error("Order not found"),p("/delivery");return}const f=new Date(a.created_at),m=new Date(f);m.setHours(0,0,0,0);const{data:U}=await r.from("orders").select("id, created_at").gte("created_at",m.toISOString()).order("created_at",{ascending:!0}),D=(U||[]).findIndex(g=>g.id===d);a.orderNumber=D>=0?D+1:1,L(a);const{data:i,error:$}=await r.from("order_items").select("id, quantity, price, product_id, variant_id").eq("order_id",d);if(P.debug("Fetched delivery order items",{itemsData:i,error:$}),i&&i.length>0){const g=i.map(t=>t.product_id),{data:F}=await r.from("products").select("id, name, image_url, unit").in("id",g),I=i.map(t=>t.variant_id).filter(Boolean);let S=new Map;if(I.length>0){const{data:t}=await r.from("product_variants").select("id, variant_name, variant_value, variant_unit").in("id",I);S=new Map((t||[]).map(u=>[u.id,u]))}const j=new Map((F||[]).map(t=>[t.id,t])),V=i.map(t=>{var C,O,q;const u=S.get(t.variant_id),H=(C=j.get(t.product_id))==null?void 0:C.unit,Y=W(t.quantity,u||null,H);return{...t,name:((O=j.get(t.product_id))==null?void 0:O.name)||"Product",image:((q=j.get(t.product_id))==null?void 0:q.image_url)||null,calculatedQty:Y}});A(V)}const{data:M}=await r.from("delivery_assignments").select("id, marked_delivered_at").eq("order_id",d).single();M&&T(M)}catch(a){P.error("Failed to fetch delivery order details",{error:a})}finally{_(!1)}}},Q=async()=>{s&&(o(!0),await r.from("orders").update({status:"out_for_delivery"}).eq("id",s.id),v.success("Order picked!"),h(),o(!1))},R=async()=>{c&&(o(!0),await r.from("delivery_assignments").update({marked_delivered_at:new Date().toISOString()}).eq("id",c.id),v.success("Marked delivered!"),h(),o(!1))},z=()=>{s!=null&&s.delivery_address&&window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(s.delivery_address)}`,"_blank")};if(B)return e.jsxs("div",{className:"min-h-screen bg-background p-4",children:[e.jsx(E,{className:"h-12 w-full mb-4"}),e.jsx(E,{className:"h-96 w-full rounded-xl"})]});if(!s)return e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:e.jsx("p",{className:"text-muted-foreground",children:"Order not found"})});const w=s.status==="pending"||s.status==="confirmed",k=s.status==="out_for_delivery"&&!(c!=null&&c.marked_delivered_at);return e.jsxs("div",{className:"min-h-screen bg-slate-100 dark:bg-slate-900 pb-24",children:[e.jsx("header",{className:"sticky top-0 z-50 bg-white dark:bg-slate-800 border-b shadow-sm",children:e.jsxs("div",{className:"flex items-center gap-3 px-4 py-3",children:[e.jsx(x,{variant:"ghost",size:"icon",onClick:()=>p("/delivery"),children:e.jsx(X,{className:"w-5 h-5"})}),e.jsx("h1",{className:"font-bold flex-1",children:"Invoice"})]})}),e.jsx("div",{className:"p-4",children:e.jsx(Z,{className:"bg-white dark:bg-slate-800 shadow-lg",children:e.jsxs(ee,{className:"p-0",children:[e.jsxs("div",{className:"p-4 border-b text-center bg-primary/5",children:[e.jsx("h2",{className:"text-lg font-bold text-primary",children:"DELIVERY INVOICE"}),e.jsxs("p",{className:"text-sm font-medium",children:["Order #",s.orderNumber||"—"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:se(new Date(s.created_at),"dd MMM yyyy, hh:mm a")})]}),e.jsx("div",{className:"p-4 border-b",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(ae,{className:"w-4 h-4 text-primary mt-0.5 shrink-0"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Deliver To:"}),e.jsx("p",{className:"text-sm font-medium",children:s.delivery_address})]}),e.jsxs(x,{size:"sm",variant:"outline",className:"shrink-0",onClick:z,children:[e.jsx(ie,{className:"w-3 h-3 mr-1"}),"Map"]})]})}),e.jsxs("div",{className:"p-4 border-b",children:[e.jsx("p",{className:"text-xs text-muted-foreground mb-3",children:"ITEMS"}),y.length===0?e.jsxs("div",{className:"text-center py-4 text-muted-foreground text-sm",children:[e.jsx(te,{className:"w-8 h-8 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"Could not load items"}),e.jsx("p",{className:"text-xs",children:"(RLS permission issue)"})]}):e.jsx("div",{className:"divide-y",children:y.map((a,f)=>{const m=a.calculatedQty||`${a.quantity} ${a.unit}`;return e.jsxs("div",{className:"py-4",children:[e.jsxs("p",{className:"font-semibold text-base leading-snug mb-2",children:[f+1,". ",a.name]}),e.jsxs("div",{className:"flex justify-between items-center bg-slate-50 dark:bg-slate-700/30 rounded-lg px-3 py-2",children:[e.jsxs("span",{className:"text-sm font-medium text-foreground",children:[m," @ ₹",a.price]}),e.jsxs("span",{className:"text-lg font-bold text-primary",children:["₹",a.quantity*a.price]})]})]},a.id)})})]}),e.jsxs("div",{className:"p-4 bg-slate-50 dark:bg-slate-700/50",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Subtotal"}),e.jsxs("span",{className:"text-sm",children:["₹",s.total_amount]})]}),e.jsxs("div",{className:"flex justify-between items-center mt-2 pt-2 border-t border-dashed",children:[e.jsx("span",{className:"font-bold text-lg",children:"TOTAL"}),e.jsxs("span",{className:"font-bold text-2xl text-primary",children:["₹",s.total_amount]})]}),e.jsxs("p",{className:"text-[10px] text-muted-foreground text-center mt-2",children:["Payment: ",s.payment_method==="cod"?"Cash on Delivery":"Prepaid"]})]})]})})}),(w||k)&&e.jsxs("div",{className:"fixed bottom-0 left-0 right-0 p-4 bg-white dark:bg-slate-800 border-t",children:[w&&e.jsxs(x,{className:"w-full h-12 bg-primary",onClick:Q,disabled:l,children:[e.jsx(re,{className:"w-5 h-5 mr-2"}),l?"Picking...":"Pick Up Order"]}),k&&e.jsxs(x,{className:"w-full h-12 bg-primary",onClick:R,disabled:l,children:[e.jsx(de,{className:"w-5 h-5 mr-2"}),l?"Marking...":"Mark Delivered"]})]})]})}export{le as default};
