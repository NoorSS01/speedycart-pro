import{k as L,r as g,s as l,l as S}from"./index-Cg7UL77a.js";function F(){const{user:u}=L(),[E,x]=g.useState([]),[M,P]=g.useState([]),[k,y]=g.useState(!0),C=g.useCallback(async r=>{if(u)try{const{data:o}=await l.from("user_product_views").select("id, view_count").eq("user_id",u.id).eq("product_id",r).single();if(o){const f=o;await l.from("user_product_views").update({view_count:(f.view_count||1)+1,viewed_at:new Date().toISOString()}).eq("id",f.id)}else await l.from("user_product_views").insert({user_id:u.id,product_id:r,view_count:1})}catch(o){S.debug("Product view tracking failed",{error:o})}},[u]),q=g.useCallback(async()=>{const r=new Map;try{const o=new Date(Date.now()-6048e5).toISOString(),{data:f}=await l.from("order_items").select("product_id, quantity").gte("created_at",o);f&&f.forEach(a=>{const n=r.get(a.product_id)||0;r.set(a.product_id,n+a.quantity)});const w=Math.max(...Array.from(r.values()),1);r.forEach((a,n)=>{r.set(n,a/w*20)})}catch(o){S.debug("Trending calculation failed",{error:o})}return r},[]),A=g.useCallback(async()=>{try{const{data:r}=await l.from("products").select("*").gt("stock_quantity",0).order("created_at",{ascending:!1});if(!r||r.length===0){y(!1);return}const o=r,f=o.map(e=>e.id),{data:w}=await l.from("product_variants").select("*").in("product_id",f).eq("is_default",!0),a=o.map(e=>{const t=(w==null?void 0:w.find(s=>s.product_id===e.id))||null;return{...e,default_variant:t}}),n=await q();if(!u){const e=[...a].sort((t,s)=>{const i=n.get(t.id)||0;return(n.get(s.id)||0)-i});P(e.slice(0,10)),x([]),y(!1);return}const{data:m}=await l.from("user_product_views").select("product_id, view_count, viewed_at").eq("user_id",u.id).order("viewed_at",{ascending:!1}).limit(50),{data:b}=await l.from("orders").select(`
                    id,
                    created_at,
                    order_items(product_id, products(category_id))
                `).eq("user_id",u.id).in("status",["delivered","out_for_delivery","confirmed"]).order("created_at",{ascending:!1}).limit(30),c={},p=new Set,I=new Date(Date.now()-14*24*60*60*1e3);b&&b.forEach(e=>{var s;const t=new Date(e.created_at||Date.now());(s=e.order_items)==null||s.forEach(i=>{var _;const d=(_=i.products)==null?void 0:_.category_id;if(d){const D=(Date.now()-t.getTime())/864e5,H=Math.exp(-D/30);c[d]=(c[d]||0)+35*H}t>I&&p.add(i.product_id)})});const h={};m&&Array.isArray(m)&&m.forEach((e,t)=>{const s=Math.exp(-t/20),i=e.view_count??1,d=Math.min(i*5*s,25);h[e.product_id]=d;const _=a.find(D=>D.id===e.product_id);_!=null&&_.category_id&&(c[_.category_id]=(c[_.category_id]||0)+i*2*s)});const O=Math.max(...Object.values(c),1);Object.keys(c).forEach(e=>{c[e]=c[e]/O*35});const T=a.map(e=>{if(p.has(e.id))return{product:e,score:-1,reasons:["recently_purchased"]};let t=0;const s=[];e.category_id&&c[e.category_id]&&(t+=c[e.category_id],s.push("category_match")),h[e.id]&&(t+=h[e.id],s.push("viewed"));const i=n.get(e.id)||0;t+=i,i>5&&s.push("trending");const d=Date.now()-new Date(e.created_at||0).getTime();return d<7*24*60*60*1e3?(t+=10,s.push("new")):d<14*24*60*60*1e3&&(t+=5),t+=Math.random()*5,{product:e,score:t,reasons:s}}).filter(e=>e.score>=0).sort((e,t)=>t.score-e.score),v={},R=4,j=T.filter(({product:e})=>{const t=e.category_id||"uncategorized";return v[t]=(v[t]||0)+1,v[t]<=R}).slice(0,12);x(j.map(e=>e.product));const B=[...a].filter(e=>!p.has(e.id)).sort((e,t)=>(n.get(t.id)||0)-(n.get(e.id)||0)).slice(0,8);P(B)}catch(r){S.error("Recommendations error",{error:r})}finally{y(!1)}},[u,q]);return g.useEffect(()=>{A()},[A]),{recommendedProducts:E,trendingProducts:M,isLoading:k,trackView:C}}export{F as u};
