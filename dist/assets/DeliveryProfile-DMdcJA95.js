import{m as me,u as xe,a as ue,r as i,s as c,l as _,j as e,S as k,B as u,A as he,C as o,c as m,n as ge,o as pe,U as $,p as fe,q as je,t as ve,e as X,v as Ne,w as be,L as J,d as ye,x as C,y as S,z as we,P as _e,D as A,I as R,E as K,F as ke,G as Ce,H as Se,h}from"./index-V0QViGkZ.js";import{P}from"./power-Bb0CfbLp.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const De=me("IndianRupee",[["path",{d:"M6 3h12",key:"ggurg9"}],["path",{d:"M6 8h12",key:"6g4wlu"}],["path",{d:"m6 13 8.5 8",key:"u1kupk"}],["path",{d:"M6 13h3",key:"wdp6ag"}],["path",{d:"M9 13c6.667 0 6.667-10 0-10",key:"1nkvk2"}]]);function Re(){var H,Y;const{user:r,loading:T,signOut:Q}=xe(),N=ue(),[V,L]=i.useState(!0),[M,E]=i.useState(!1),[l,D]=i.useState({phone:"",full_name:"",email:"",username:null}),[x,Z]=i.useState({today:0,week:0,month:0,allTime:0,todayDeliveries:0,totalDeliveries:0,avgRating:0}),[ee,se]=i.useState(!0),[a,b]=i.useState("none"),[g,O]=i.useState(!1),[I,te]=i.useState([]),[q,y]=i.useState(null),[p,z]=i.useState(0);i.useEffect(()=>{if(!T){if(!r){N("/auth");return}ae(),F(),U()}},[r,T,N]);const ae=async()=>{if(r){L(!0);try{const{data:s}=await c.from("profiles").select("phone, full_name, username").eq("id",r.id).single();if(s){const n=s;D({phone:n.phone||"",full_name:n.full_name||"",email:r.email||"",username:n.username||null})}const t=new Date,d=new Date(t);d.setHours(0,0,0,0);const f=new Date(t);f.setDate(f.getDate()-7);const j=new Date(t);j.setMonth(j.getMonth()-1);const{data:le}=await c.from("delivery_assignments").select("id, user_confirmed_at").eq("delivery_person_id",r.id).not("user_confirmed_at","is",null),v=le||[],G=v.filter(n=>n.user_confirmed_at&&new Date(n.user_confirmed_at)>=d),ie=v.filter(n=>n.user_confirmed_at&&new Date(n.user_confirmed_at)>=f),ce=v.filter(n=>n.user_confirmed_at&&new Date(n.user_confirmed_at)>=j),{data:w}=await c.from("delivery_ratings").select("rating").eq("delivery_person_id",r.id),de=w&&w.length>0?w.reduce((n,oe)=>n+(oe.rating??0),0)/w.length:0;Z({today:G.length*5,week:ie.length*5,month:ce.length*5,allTime:v.length*5,todayDeliveries:G.length,totalDeliveries:v.length,avgRating:Math.round(de*10)/10})}catch(s){_.error("Error fetching delivery profile data",{error:s})}finally{L(!1)}}},re=async()=>{var s;if(r){E(!0);try{const{error:t}=await c.from("profiles").update({full_name:l.full_name,username:((s=l.username)==null?void 0:s.toLowerCase())||null}).eq("id",r.id);if(t)throw t;h.success("Profile updated!")}catch{h.error("Failed to update profile")}finally{E(!1)}}},ne=async()=>{await Q(),N("/auth")},F=async()=>{if(!r)return;const s=new Date().toISOString().split("T")[0];try{const{data:t}=await c.from("delivery_activations").select("status, updated_at").eq("delivery_partner_id",r.id).eq("activation_date",s).maybeSingle();t&&t.status?(b(t.status),t.status==="rejected"&&t.updated_at?y(new Date(t.updated_at)):y(null)):(b("none"),y(null))}catch{_.debug("Activation status not available"),b("none")}};i.useEffect(()=>{if(!q||a!=="rejected"){z(0);return}const s=5*60*1e3,t=()=>{const f=Date.now()-q.getTime(),j=Math.max(0,s-f);z(j)};t();const d=setInterval(t,1e3);return()=>clearInterval(d)},[q,a]);const B=async()=>{if(r){O(!0);try{const s=new Date().toISOString().split("T")[0];a==="rejected"&&p===0&&await c.from("delivery_activations").delete().eq("delivery_partner_id",r.id).eq("activation_date",s);const{error:t}=await c.from("delivery_activations").insert({delivery_partner_id:r.id,activation_date:s,status:"pending"});if((t==null?void 0:t.code)==="23505")h.info("You already requested activation today"),F();else{if(t)throw t;h.success("Activation request sent! Waiting for admin approval."),b("pending"),y(null)}}catch(s){h.error("Failed to request activation"),_.error("Activation request failed",{error:s})}O(!1)}},U=async()=>{if(r)try{const{data:s}=await c.from("payouts").select("*").eq("payee_id",r.id).eq("type","delivery_commission").order("created_at",{ascending:!1}).limit(10);s&&te(s)}catch(s){_.debug("Payouts fetch failed",{error:s})}},W=async(s,t)=>{try{const{error:d}=await c.from("payouts").update({status:t}).eq("id",s);if(d)throw d;h.success(`Payout ${t}`),U()}catch{h.error("Failed to update payout")}};return V?e.jsxs("div",{className:"min-h-screen bg-background p-4",children:[e.jsx(k,{className:"h-12 w-full mb-4"}),e.jsx(k,{className:"h-32 w-full mb-4 rounded-xl"}),e.jsx(k,{className:"h-48 w-full mb-4 rounded-xl"}),e.jsx(k,{className:"h-64 w-full rounded-xl"})]}):e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-primary/5 via-background to-accent/5 pb-8",children:[e.jsx("header",{className:"sticky top-0 z-50 bg-background/80 backdrop-blur-xl border-b",children:e.jsxs("div",{className:"flex items-center gap-3 px-4 py-3",children:[e.jsx(u,{variant:"ghost",size:"icon",onClick:()=>N("/delivery"),children:e.jsx(he,{className:"w-5 h-5"})}),e.jsx("h1",{className:"text-xl font-bold",children:"My Account"})]})}),e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsx(o,{children:e.jsx(m,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(ge,{className:"w-16 h-16 border-2 border-primary",children:e.jsx(pe,{className:"bg-primary/10 text-primary text-xl",children:((Y=(H=l.full_name)==null?void 0:H[0])==null?void 0:Y.toUpperCase())||e.jsx($,{className:"w-6 h-6"})})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h2",{className:"text-lg font-bold",children:l.full_name||"Delivery Partner"}),e.jsxs("p",{className:"text-sm text-muted-foreground flex items-center gap-1",children:[e.jsx(fe,{className:"w-3 h-3"})," ",l.phone||"No phone"]}),l.email&&e.jsxs("p",{className:"text-sm text-muted-foreground flex items-center gap-1",children:[e.jsx(je,{className:"w-3 h-3"})," ",l.email]})]}),e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"flex items-center justify-center gap-1 text-amber-500",children:[e.jsx(ve,{className:"w-5 h-5 fill-current"}),e.jsx("span",{className:"text-lg font-bold",children:x.avgRating||"—"})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Rating"})]})]})})}),e.jsx(o,{className:a==="approved"?"border-green-500 bg-green-500/5":a==="pending"?"border-amber-500 bg-amber-500/5":"",children:e.jsx(m,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`w-12 h-12 rounded-full flex items-center justify-center ${a==="approved"?"bg-green-500":a==="pending"?"bg-amber-500":a==="rejected"?"bg-red-500":"bg-muted"}`,children:a==="approved"?e.jsx(X,{className:"w-6 h-6 text-white"}):a==="pending"?e.jsx(Ne,{className:"w-6 h-6 text-white"}):a==="rejected"?e.jsx(be,{className:"w-6 h-6 text-white"}):e.jsx(P,{className:"w-6 h-6 text-muted-foreground"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold",children:a==="approved"?"Active Today":a==="pending"?"Awaiting Approval":a==="rejected"?"Request Rejected":"Not Active"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:a==="approved"?"You can receive orders":a==="pending"?"Admin will review shortly":a==="rejected"?"Contact admin for details":"Request to go active for today"})]})]}),a==="none"&&e.jsxs(u,{onClick:B,disabled:g,children:[g?e.jsx(J,{className:"w-4 h-4 animate-spin"}):e.jsx(P,{className:"w-4 h-4 mr-2"}),g?"Requesting...":"Go Active"]}),a==="rejected"&&p===0&&e.jsxs(u,{onClick:B,disabled:g,children:[g?e.jsx(J,{className:"w-4 h-4 animate-spin"}):e.jsx(P,{className:"w-4 h-4 mr-2"}),g?"Requesting...":"Request Again"]}),a==="rejected"&&p>0&&e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Wait ",Math.ceil(p/6e4),"m ",Math.floor(p%6e4/1e3),"s"]})]})})}),e.jsxs("div",{children:[e.jsx("h2",{className:"font-semibold mb-3",children:"Recent Payouts"}),e.jsx("div",{className:"space-y-3",children:I.length===0?e.jsx(o,{children:e.jsx(m,{className:"p-4 text-center text-muted-foreground",children:"No payment history"})}):I.map(s=>e.jsx(o,{className:"overflow-hidden",children:e.jsxs(m,{className:"p-4",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"font-bold text-lg",children:["₹",s.amount]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:new Date(s.created_at).toLocaleDateString()})]}),e.jsx(ye,{variant:s.status==="approved"?"default":s.status==="pending"?"outline":"destructive",children:s.status})]}),s.status==="pending"&&e.jsxs("div",{className:"mt-3 flex gap-2",children:[e.jsx(u,{size:"sm",variant:"outline",className:"w-full border-red-200 text-red-600 hover:bg-red-50 hover:text-red-700",onClick:()=>W(s.id,"rejected"),children:"Reject"}),e.jsx(u,{size:"sm",className:"w-full bg-green-600 hover:bg-green-700",onClick:()=>W(s.id,"approved"),children:"Confirm Receipt"})]})]})},s.id))})]}),e.jsxs(o,{className:"bg-primary/5 border-primary/20",children:[e.jsx(C,{className:"pb-2",children:e.jsxs(S,{className:"text-sm flex items-center gap-2",children:[e.jsx(De,{className:"w-4 h-4"}),"Earnings Overview"]})}),e.jsx(m,{children:e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"bg-background rounded-lg p-3 text-center",children:[e.jsxs("p",{className:"text-2xl font-bold text-primary",children:["₹",x.today]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Today"})]}),e.jsxs("div",{className:"bg-background rounded-lg p-3 text-center",children:[e.jsxs("p",{className:"text-2xl font-bold text-primary",children:["₹",x.week]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"This Week"})]}),e.jsxs("div",{className:"bg-background rounded-lg p-3 text-center",children:[e.jsxs("p",{className:"text-2xl font-bold text-primary",children:["₹",x.month]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"This Month"})]}),e.jsxs("div",{className:"bg-background rounded-lg p-3 text-center",children:[e.jsxs("p",{className:"text-2xl font-bold text-primary",children:["₹",x.allTime]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"All Time"})]})]})})]}),e.jsxs(o,{children:[e.jsx(C,{className:"pb-2",children:e.jsxs(S,{className:"text-sm flex items-center gap-2",children:[e.jsx(we,{className:"w-4 h-4"}),"Delivery Statistics"]})}),e.jsx(m,{children:e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-emerald-50 dark:bg-emerald-900/20 rounded-lg",children:[e.jsx(_e,{className:"w-8 h-8 text-emerald-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xl font-bold",children:x.todayDeliveries}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Today"})]})]}),e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg",children:[e.jsx(X,{className:"w-8 h-8 text-blue-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xl font-bold",children:x.totalDeliveries}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Total"})]})]})]})})]}),e.jsxs(o,{children:[e.jsx(C,{className:"pb-2",children:e.jsxs(S,{className:"text-sm flex items-center gap-2",children:[e.jsx($,{className:"w-4 h-4"}),"Edit Profile"]})}),e.jsxs(m,{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(A,{children:"Full Name"}),e.jsx(R,{value:l.full_name||"",onChange:s=>D({...l,full_name:s.target.value}),placeholder:"Your name"})]}),e.jsxs("div",{children:[e.jsx(A,{children:"Username"}),e.jsxs("div",{className:"flex",children:[e.jsx("div",{className:"flex items-center justify-center px-3 bg-muted border border-r-0 rounded-l-md text-sm font-medium text-muted-foreground",children:"@"}),e.jsx(R,{value:l.username||"",onChange:s=>D({...l,username:s.target.value.toLowerCase().replace(/[^a-z0-9_]/g,"").slice(0,20)}),placeholder:"your_username",className:"rounded-l-none",maxLength:20})]}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Letters, numbers, underscores (3-20 chars)"})]}),e.jsxs("div",{children:[e.jsx(A,{children:"Phone Number"}),e.jsx(R,{value:l.phone,disabled:!0,className:"bg-muted"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Contact support to change phone number"})]}),e.jsx(u,{onClick:re,disabled:M,className:"w-full",children:M?"Saving...":"Save Changes"})]})]}),e.jsxs(o,{children:[e.jsx(C,{className:"pb-2",children:e.jsxs(S,{className:"text-sm flex items-center gap-2",children:[e.jsx(K,{className:"w-4 h-4"}),"Settings"]})}),e.jsx(m,{className:"space-y-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(K,{className:"w-4 h-4 text-muted-foreground"}),e.jsx("span",{className:"text-sm",children:"Push Notifications"})]}),e.jsx(ke,{checked:ee,onCheckedChange:se})]})})]}),e.jsx(Ce,{}),e.jsxs(u,{variant:"destructive",className:"w-full",onClick:ne,children:[e.jsx(Se,{className:"w-4 h-4 mr-2"}),"Sign Out"]})]})]})}export{Re as default};
