import{u as G,a as J,o as K,r as i,s as d,n as y,l as q,p as W,j as e,S as P,B as f,A as X,C as Z,c as ee,h as se,M as ae,P as te,T as re,k as de}from"./index-C-DPp9gG.js";import{N as ie}from"./navigation-R71esG3O.js";function le(){const{user:o}=G(),c=J(),{orderId:r}=K(),[t,E]=i.useState(null),[b,L]=i.useState([]),[l,A]=i.useState(null),[T,N]=i.useState(!0),[m,u]=i.useState(!1),x=i.useCallback(async()=>{if(r&&o){N(!0);try{const{data:a}=await d.from("orders").select("*").eq("id",r).single();if(!a){y.error("Order not found"),c("/delivery");return}const g=new Date(a.created_at||Date.now()),p=new Date(g);p.setHours(0,0,0,0);const{data:B}=await d.from("orders").select("id, created_at").gte("created_at",p.toISOString()).order("created_at",{ascending:!0}),k=(B||[]).findIndex(v=>v.id===r),U={id:a.id,created_at:a.created_at,status:a.status,total_amount:a.total_amount,delivery_address:a.delivery_address,orderNumber:k>=0?k+1:1};E(U);const{data:n,error:$}=await d.from("order_items").select("id, quantity, price, product_id, variant_id").eq("order_id",r);if(q.debug("Fetched delivery order items",{itemsData:n,error:$}),n&&n.length>0){const v=n.map(s=>s.product_id),{data:F}=await d.from("products").select("id, name, image_url, unit").in("id",v),M=n.map(s=>s.variant_id).filter(s=>s!==null);let C=new Map;if(M.length>0){const{data:s}=await d.from("product_variants").select("id, variant_name, variant_value, variant_unit").in("id",M);C=new Map((s||[]).map(h=>[h.id,h]))}const j=new Map((F||[]).map(s=>[s.id,s])),V=n.map(s=>{var I,O,S;const h=s.variant_id?C.get(s.variant_id):void 0,H=((I=j.get(s.product_id))==null?void 0:I.unit)??void 0,Y=W(s.quantity,h||null,H);return{id:s.id,quantity:s.quantity,price:s.price,product_id:s.product_id,variant_id:s.variant_id,name:((O=j.get(s.product_id))==null?void 0:O.name)||"Product",image:((S=j.get(s.product_id))==null?void 0:S.image_url)||null,calculatedQty:Y}});L(V)}const{data:D}=await d.from("delivery_assignments").select("id, marked_delivered_at").eq("order_id",r).single();D&&A(D)}catch(a){q.error("Failed to fetch delivery order details",{error:a})}finally{N(!1)}}},[r,o,c]);i.useEffect(()=>{if(!o){c("/auth");return}r&&x()},[o,r,c,x]);const Q=async()=>{t&&(u(!0),await d.from("orders").update({status:"out_for_delivery"}).eq("id",t.id),y.success("Order picked!"),x(),u(!1))},R=async()=>{l&&(u(!0),await d.from("delivery_assignments").update({marked_delivered_at:new Date().toISOString()}).eq("id",l.id),y.success("Marked delivered!"),x(),u(!1))},z=()=>{t!=null&&t.delivery_address&&window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(t.delivery_address)}`,"_blank")};if(T)return e.jsxs("div",{className:"min-h-screen bg-background p-4",children:[e.jsx(P,{className:"h-12 w-full mb-4"}),e.jsx(P,{className:"h-96 w-full rounded-xl"})]});if(!t)return e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:e.jsx("p",{className:"text-muted-foreground",children:"Order not found"})});const _=t.status==="pending"||t.status==="confirmed",w=t.status==="out_for_delivery"&&!(l!=null&&l.marked_delivered_at);return e.jsxs("div",{className:"min-h-screen bg-slate-100 dark:bg-slate-900 pb-24",children:[e.jsx("header",{className:"sticky top-0 z-50 bg-white dark:bg-slate-800 border-b shadow-sm",children:e.jsxs("div",{className:"flex items-center gap-3 px-4 py-3",children:[e.jsx(f,{variant:"ghost",size:"icon",onClick:()=>c("/delivery"),children:e.jsx(X,{className:"w-5 h-5"})}),e.jsx("h1",{className:"font-bold flex-1",children:"Invoice"})]})}),e.jsx("div",{className:"p-4",children:e.jsx(Z,{className:"bg-white dark:bg-slate-800 shadow-lg",children:e.jsxs(ee,{className:"p-0",children:[e.jsxs("div",{className:"p-4 border-b text-center bg-primary/5",children:[e.jsx("h2",{className:"text-lg font-bold text-primary",children:"DELIVERY INVOICE"}),e.jsxs("p",{className:"text-sm font-medium",children:["Order #",t.orderNumber||"—"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:se(new Date(t.created_at||Date.now()),"dd MMM yyyy, hh:mm a")})]}),e.jsx("div",{className:"p-4 border-b",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(ae,{className:"w-4 h-4 text-primary mt-0.5 shrink-0"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Deliver To:"}),e.jsx("p",{className:"text-sm font-medium",children:t.delivery_address})]}),e.jsxs(f,{size:"sm",variant:"outline",className:"shrink-0",onClick:z,children:[e.jsx(ie,{className:"w-3 h-3 mr-1"}),"Map"]})]})}),e.jsxs("div",{className:"p-4 border-b",children:[e.jsx("p",{className:"text-xs text-muted-foreground mb-3",children:"ITEMS"}),b.length===0?e.jsxs("div",{className:"text-center py-4 text-muted-foreground text-sm",children:[e.jsx(te,{className:"w-8 h-8 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"Could not load items"}),e.jsx("p",{className:"text-xs",children:"(RLS permission issue)"})]}):e.jsx("div",{className:"divide-y",children:b.map((a,g)=>{const p=a.calculatedQty||`${a.quantity} ${a.unit}`;return e.jsxs("div",{className:"py-4",children:[e.jsxs("p",{className:"font-semibold text-base leading-snug mb-2",children:[g+1,". ",a.name]}),e.jsxs("div",{className:"flex justify-between items-center bg-slate-50 dark:bg-slate-700/30 rounded-lg px-3 py-2",children:[e.jsxs("span",{className:"text-sm font-medium text-foreground",children:[p," @ ₹",a.price]}),e.jsxs("span",{className:"text-lg font-bold text-primary",children:["₹",a.quantity*a.price]})]})]},a.id)})})]}),e.jsxs("div",{className:"p-4 bg-slate-50 dark:bg-slate-700/50",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Subtotal"}),e.jsxs("span",{className:"text-sm",children:["₹",t.total_amount]})]}),e.jsxs("div",{className:"flex justify-between items-center mt-2 pt-2 border-t border-dashed",children:[e.jsx("span",{className:"font-bold text-lg",children:"TOTAL"}),e.jsxs("span",{className:"font-bold text-2xl text-primary",children:["₹",t.total_amount]})]}),e.jsxs("p",{className:"text-[10px] text-muted-foreground text-center mt-2",children:["Payment: ",t.payment_method==="cod"?"Cash on Delivery":"Prepaid"]})]})]})})}),(_||w)&&e.jsxs("div",{className:"fixed bottom-0 left-0 right-0 p-4 bg-white dark:bg-slate-800 border-t",children:[_&&e.jsxs(f,{className:"w-full h-12 bg-primary",onClick:Q,disabled:m,children:[e.jsx(re,{className:"w-5 h-5 mr-2"}),m?"Picking...":"Pick Up Order"]}),w&&e.jsxs(f,{className:"w-full h-12 bg-primary",onClick:R,disabled:m,children:[e.jsx(de,{className:"w-5 h-5 mr-2"}),m?"Marking...":"Mark Delivered"]})]})]})}export{le as default};
