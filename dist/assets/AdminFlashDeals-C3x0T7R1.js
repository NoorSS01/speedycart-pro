import{u as K,a as Q,r as n,s as d,l as H,j as e,S as M,B as m,A as X,Z as v,Q as A,C as T,c as L,z as Y,h as u,i as G,K as y,$ as J,a0 as W,a1 as ee,a2 as te,a3 as se,H as l,I as o,a5 as ae,a6 as re,a7 as ce,a8 as le,a9 as P,aa as ie,Y as oe,P as ne,a4 as de,n as i}from"./index-BASgNFzI.js";import{A as me}from"./AdminBottomNav-DtMwhqJL.js";import{P as ue}from"./pencil-JA67TztW.js";function ge(){const{user:b,userRole:N,loading:w}=K(),g=Q(),[p,E]=n.useState([]),[I,B]=n.useState(!0),[q,x]=n.useState(!1),[_,D]=n.useState(null),[a,c]=n.useState({name:"",title:"FLASH DEALS",badge_text:"Up To 80% Off",badge_color:"#ec4899",start_time:"",end_time:"",background_color:"#fef3c7",text_color:"#000000",timer_bg_color:"#1e293b",timer_text_color:"#ffffff",filter_type:"manual",min_discount:30,product_ids:[],max_products:8,show_see_all:!0,is_active:!0,display_order:0}),[C,z]=n.useState([]),[k,f]=n.useState(""),S=N==="admin"||N==="super_admin";n.useEffect(()=>{if(!w){if(!b||!S){g("/");return}h(),O()}},[b,w,S,g]);const O=async()=>{const{data:t}=await d.from("products").select("id, name, image_url").eq("is_active",!0).order("name");t&&z(t)},h=async()=>{try{const{data:t}=await d.from("flash_deals").select("*").order("display_order",{ascending:!0});if(t){const s=t.map(r=>({...r,badge_color:r.badge_color||"#ec4899",background_color:r.background_color||"#fef3c7",text_color:r.text_color||"#000000",timer_bg_color:r.timer_bg_color||"#1e293b",timer_text_color:r.timer_text_color||"#ffffff",filter_type:r.filter_type||"manual",max_products:r.max_products||8,show_see_all:r.show_see_all??!0,is_active:r.is_active??!1,display_order:r.display_order||0}));E(s)}}catch(t){H.error("Failed to fetch flash deals",{error:t})}B(!1)},F=()=>{const t=new Date,s=new Date(t.getTime()+24*60*60*1e3);D(null),c({name:"",title:"FLASH DEALS",badge_text:"Up To 80% Off",badge_color:"#ec4899",start_time:u(t,"yyyy-MM-dd'T'HH:mm"),end_time:u(s,"yyyy-MM-dd'T'HH:mm"),background_color:"#fef3c7",text_color:"#000000",timer_bg_color:"#1e293b",timer_text_color:"#ffffff",filter_type:"manual",min_discount:30,product_ids:[],max_products:8,show_see_all:!0,is_active:!0,display_order:p.length}),f(""),x(!0)},U=t=>{D(t);const s=t.filter_config||{};c({name:t.name,title:t.title,badge_text:t.badge_text||"",badge_color:t.badge_color,start_time:u(new Date(t.start_time),"yyyy-MM-dd'T'HH:mm"),end_time:u(new Date(t.end_time),"yyyy-MM-dd'T'HH:mm"),background_color:t.background_color,text_color:t.text_color,timer_bg_color:t.timer_bg_color,timer_text_color:t.timer_text_color,filter_type:t.filter_type,min_discount:s.min_discount||30,product_ids:s.product_ids||[],max_products:t.max_products,show_see_all:t.show_see_all,is_active:t.is_active,display_order:t.display_order}),f(""),x(!0)},$=async()=>{if(!a.name.trim()||!a.title.trim()){i.error("Name and title required");return}if(!a.start_time||!a.end_time){i.error("Start and end times required");return}if(new Date(a.end_time)<=new Date(a.start_time)){i.error("End time must be after start time");return}if(a.filter_type==="discount"){const t=a.min_discount||0;if(t<=0||t>100){i.error("Invalid discount percentage");return}const{count:s,error:r}=await d.from("products").select("*",{count:"exact",head:!0}).gte("discount_percent",t).eq("is_active",!0);if(r){H.error("Failed to validate discount products",{error:r}),i.error("Failed to validate product criteria");return}if(s===0){i.error(`No active products found with >= ${t}% discount`);return}}else if(a.filter_type==="manual"&&a.product_ids.length===0){i.error("Please select at least one product");return}try{const t={name:a.name,title:a.title,badge_text:a.badge_text||null,badge_color:a.badge_color,start_time:new Date(a.start_time).toISOString(),end_time:new Date(a.end_time).toISOString(),background_color:a.background_color,text_color:a.text_color,timer_bg_color:a.timer_bg_color,timer_text_color:a.timer_text_color,filter_type:a.filter_type,filter_config:a.filter_type==="manual"?{product_ids:a.product_ids}:{min_discount:a.min_discount},max_products:a.max_products,show_see_all:a.show_see_all,is_active:a.is_active,display_order:a.display_order,updated_at:new Date().toISOString()};_?(await d.from("flash_deals").update(t).eq("id",_.id),i.success("Flash deal updated")):(await d.from("flash_deals").insert(t),i.success("Flash deal created")),x(!1),h()}catch{i.error("Failed to save")}},R=async t=>{if(confirm("Delete this flash deal?"))try{await d.from("flash_deals").delete().eq("id",t),i.success("Deleted"),h()}catch{i.error("Failed")}},V=async t=>{try{await d.from("flash_deals").update({is_active:!t.is_active}).eq("id",t.id),h()}catch{i.error("Failed")}},Z=t=>{const s=new Date,r=new Date(t.start_time),j=new Date(t.end_time);return t.is_active?s<r?{label:"Scheduled",color:"outline"}:s>j?{label:"Expired",color:"destructive"}:{label:"Live",color:"default"}:{label:"Inactive",color:"secondary"}};return I?e.jsxs("div",{className:"min-h-screen bg-background pb-20",children:[e.jsx("header",{className:"sticky top-0 z-40 border-b bg-background/95 backdrop-blur",children:e.jsx("div",{className:"container mx-auto px-4 py-4",children:e.jsx(M,{className:"h-6 w-40"})})}),e.jsx("div",{className:"container mx-auto px-4 py-6 space-y-4",children:[1,2].map(t=>e.jsx(M,{className:"h-24 rounded-xl"},t))})]}):e.jsxs("div",{className:"min-h-screen bg-background pb-20",children:[e.jsx("header",{className:"sticky top-0 z-40 border-b bg-background/95 backdrop-blur",children:e.jsxs("div",{className:"container mx-auto px-4 py-4 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(m,{variant:"ghost",size:"icon",onClick:()=>g("/admin"),children:e.jsx(X,{className:"h-5 w-5"})}),e.jsxs("div",{children:[e.jsxs("h1",{className:"text-lg font-bold flex items-center gap-2",children:[e.jsx(v,{className:"h-5 w-5 text-yellow-500"})," Flash Deals"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Time-limited offers"})]})]}),e.jsxs(m,{onClick:F,size:"sm",children:[e.jsx(A,{className:"h-4 w-4 mr-1"})," Add Deal"]})]})}),e.jsx("div",{className:"container mx-auto px-4 py-6 space-y-4",children:p.length===0?e.jsx(T,{children:e.jsxs(L,{className:"py-12 text-center",children:[e.jsx(v,{className:"h-12 w-12 mx-auto mb-4 text-muted-foreground opacity-50"}),e.jsx("p",{className:"text-muted-foreground",children:"No flash deals yet"}),e.jsxs(m,{onClick:F,className:"mt-4",children:[e.jsx(A,{className:"h-4 w-4 mr-2"})," Create First Deal"]})]})}):p.map(t=>{const s=Z(t);return e.jsxs(T,{className:t.is_active?"":"opacity-60",children:[e.jsxs("div",{className:"p-4 rounded-t-lg flex items-center justify-between",style:{backgroundColor:t.background_color,color:t.text_color},children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(v,{className:"h-5 w-5"}),e.jsx("span",{className:"font-bold",children:t.title}),t.badge_text&&e.jsx("span",{className:"text-xs px-2 py-0.5 rounded-full text-white",style:{backgroundColor:t.badge_color},children:t.badge_text})]}),e.jsxs("div",{className:"flex items-center gap-1 text-sm",children:[e.jsx(Y,{className:"h-4 w-4"}),e.jsx("span",{children:u(new Date(t.end_time),"MMM d, HH:mm")})]})]}),e.jsx(L,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(G,{variant:s.color,children:s.label}),e.jsx("span",{className:"text-xs text-muted-foreground",children:t.name})]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[u(new Date(t.start_time),"MMM d HH:mm")," - ",u(new Date(t.end_time),"MMM d HH:mm")]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(y,{checked:t.is_active,onCheckedChange:()=>V(t)}),e.jsx(m,{variant:"ghost",size:"icon",onClick:()=>U(t),children:e.jsx(ue,{className:"h-4 w-4"})}),e.jsx(m,{variant:"ghost",size:"icon",onClick:()=>R(t.id),children:e.jsx(J,{className:"h-4 w-4 text-destructive"})})]})]})})]},t.id)})}),e.jsx(W,{open:q,onOpenChange:x,children:e.jsxs(ee,{className:"max-w-lg max-h-[90vh] overflow-y-auto",children:[e.jsx(te,{children:e.jsx(se,{children:_?"Edit Flash Deal":"Create Flash Deal"})}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{children:"Internal Name *"}),e.jsx(o,{value:a.name,onChange:t=>c(s=>({...s,name:t.target.value})),placeholder:"new-year-flash"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{children:"Display Title *"}),e.jsx(o,{value:a.title,onChange:t=>c(s=>({...s,title:t.target.value})),placeholder:"FLASH DEALS"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{children:"Badge Text"}),e.jsx(o,{value:a.badge_text,onChange:t=>c(s=>({...s,badge_text:t.target.value})),placeholder:"Up To 80% Off"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{children:"Badge Color"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"color",value:a.badge_color,onChange:t=>c(s=>({...s,badge_color:t.target.value})),className:"h-10 w-14"}),e.jsx(o,{value:a.badge_color,onChange:t=>c(s=>({...s,badge_color:t.target.value}))})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{children:"Start Time *"}),e.jsx(o,{type:"datetime-local",value:a.start_time,onChange:t=>c(s=>({...s,start_time:t.target.value}))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{children:"End Time *"}),e.jsx(o,{type:"datetime-local",value:a.end_time,onChange:t=>c(s=>({...s,end_time:t.target.value}))})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{children:"Background Color"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"color",value:a.background_color,onChange:t=>c(s=>({...s,background_color:t.target.value})),className:"h-10 w-14"}),e.jsx(o,{value:a.background_color,onChange:t=>c(s=>({...s,background_color:t.target.value}))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{children:"Timer Background"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"color",value:a.timer_bg_color,onChange:t=>c(s=>({...s,timer_bg_color:t.target.value})),className:"h-10 w-14"}),e.jsx(o,{value:a.timer_bg_color,onChange:t=>c(s=>({...s,timer_bg_color:t.target.value}))})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{children:"Product Selection"}),e.jsxs(ae,{value:a.filter_type,onValueChange:t=>c(s=>({...s,filter_type:t})),children:[e.jsx(re,{children:e.jsx(ce,{})}),e.jsxs(le,{children:[e.jsx(P,{value:"manual",children:"Select Products"}),e.jsx(P,{value:"discount",children:"By Discount %"})]})]})]}),a.filter_type==="discount"&&e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{children:"Min Discount %"}),e.jsx(o,{type:"number",value:a.min_discount,onChange:t=>c(s=>({...s,min_discount:parseInt(t.target.value)||0}))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{children:"Max Products"}),e.jsx(o,{type:"number",value:a.max_products,onChange:t=>c(s=>({...s,max_products:parseInt(t.target.value)||8}))})]})]}),a.filter_type==="manual"&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs(l,{children:["Select Products (",a.product_ids.length," selected)"]}),a.product_ids.length>0&&e.jsx("div",{className:"flex flex-wrap gap-2 p-2 border rounded bg-muted/30",children:a.product_ids.map(t=>{const s=C.find(r=>r.id===t);return s?e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 text-xs bg-primary text-white rounded-full",children:[s.name.slice(0,20),s.name.length>20?"...":"",e.jsx("button",{type:"button",onClick:()=>c(r=>({...r,product_ids:r.product_ids.filter(j=>j!==t)})),className:"hover:bg-white/20 rounded-full p-0.5",children:e.jsx(ie,{className:"h-3 w-3"})})]},t):null})}),e.jsxs("div",{className:"relative",children:[e.jsx(oe,{className:"absolute left-2 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(o,{placeholder:"Search products...",value:k,onChange:t=>f(t.target.value),className:"pl-8"})]}),e.jsx("div",{className:"max-h-40 overflow-y-auto border rounded p-2 space-y-1",children:C.filter(t=>t.name.toLowerCase().includes(k.toLowerCase())).slice(0,20).map(t=>e.jsxs("button",{type:"button",className:`w-full flex items-center gap-2 p-2 rounded text-left text-sm hover:bg-muted ${a.product_ids.includes(t.id)?"bg-primary/10 border-primary border":""}`,onClick:()=>{c(s=>({...s,product_ids:s.product_ids.includes(t.id)?s.product_ids.filter(r=>r!==t.id):[...s.product_ids,t.id]}))},children:[t.image_url?e.jsx("img",{src:t.image_url,alt:"",className:"w-8 h-8 rounded object-cover"}):e.jsx("div",{className:"w-8 h-8 rounded bg-muted flex items-center justify-center",children:e.jsx(ne,{className:"h-4 w-4 text-muted-foreground"})}),e.jsx("span",{className:"flex-1 truncate",children:t.name}),a.product_ids.includes(t.id)&&e.jsx("span",{className:"text-primary text-xs",children:"âœ“"})]},t.id))})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(y,{id:"seeall",checked:a.show_see_all,onCheckedChange:t=>c(s=>({...s,show_see_all:t}))}),e.jsx(l,{htmlFor:"seeall",children:'Show "See All"'})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(y,{id:"active",checked:a.is_active,onCheckedChange:t=>c(s=>({...s,is_active:t}))}),e.jsx(l,{htmlFor:"active",children:"Active"})]})]})]}),e.jsxs(de,{children:[e.jsx(m,{variant:"outline",onClick:()=>x(!1),children:"Cancel"}),e.jsx(m,{onClick:$,children:_?"Save":"Create"})]})]})}),e.jsx(me,{})]})}export{ge as default};
