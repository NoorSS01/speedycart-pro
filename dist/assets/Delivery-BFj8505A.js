import{u as Z,b as ee,r as l,ak as se,s as x,l as B,j as e,f as D,B as C,U as te,al as I,k as j,m as b,am as re,q as ae,G as ne,an as ie,C as $,o as de,y as S}from"./index-DxtDyefn.js";import{T as le,a as oe,b as M,c as E}from"./tabs-rWvhnjDw.js";import{N as ce}from"./navigation-5pmdB1iA.js";import{T as me}from"./timer-CdnXKjAC.js";import"./index-Q_5-XCja.js";function fe(){const{user:v,userRole:O,loading:R}=Z(),u=ee(),[g,A]=l.useState([]),[F,L]=l.useState(!0),[N,y]=l.useState(null),[H,U]=l.useState(new Date),[h,z]=l.useState("today"),{deliveryTimeMinutes:P}=se();l.useEffect(()=>{const s=setInterval(()=>U(new Date),1e3);return()=>clearInterval(s)},[]),l.useEffect(()=>{if(R)return;if(!v){u("/auth");return}if(O!=="delivery"&&O!=="super_admin"){u("/");return}p();const s=x.channel("delivery-sync").on("postgres_changes",{event:"*",schema:"public",table:"delivery_assignments"},p).on("postgres_changes",{event:"*",schema:"public",table:"orders"},p).subscribe();return()=>{x.removeChannel(s)}},[v,O,R,u]);const p=async()=>{if(!v){L(!1);return}try{const s=new Date;s.setHours(0,0,0,0);const{data:t}=await x.from("orders").select("id, created_at").gte("created_at",s.toISOString()).order("created_at",{ascending:!0}),r={};(t||[]).forEach((i,a)=>{r[i.id]=a+1});const{data:n,error:d}=await x.from("delivery_assignments").select(`
          id, order_id, assigned_at, marked_delivered_at, user_confirmed_at, is_rejected,
          orders!inner (id, total_amount, delivery_address, status, created_at)
        `).eq("delivery_person_id",v.id).order("assigned_at",{ascending:!1});if(d)B.error("Delivery assignments fetch error",{error:d}),A([]);else{const i=(n||[]).map(a=>({...a,is_rejected:a.is_rejected||!1,orderNumber:r[a.orders.id]||0}));A(i)}}catch(s){B.error("Exception fetching delivery data",{error:s}),A([])}finally{L(!1)}},G=s=>{const t=new Date(s),r=new Date(t.getTime()+P*60*1e3),n=Math.max(0,r.getTime()-H.getTime()),d=P*60*1e3,i=n/d*100,a=Math.floor(n/6e4),X=Math.floor(n%6e4/1e3),Y=n>0?`${a}:${X.toString().padStart(2,"0")}`:"0:00";let T;return i>50?T="green":i>25?T="yellow":T="red",{timeString:Y,color:T,isExpired:n===0}},V=async(s,t,r)=>{s.stopPropagation(),y(t);const{error:n}=await x.from("orders").update({status:"out_for_delivery"}).eq("id",r);n?S.error("Failed"):(S.success("Order picked up!"),p()),y(null)},W=async(s,t)=>{s.stopPropagation(),y(t);const{error:r}=await x.from("delivery_assignments").update({marked_delivered_at:new Date().toISOString(),is_rejected:!1}).eq("id",t);r?S.error("Failed"):(S.success("Marked as delivered!"),p()),y(null)},J=(s,t)=>{s.stopPropagation(),window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(t)}`,"_blank")},K=s=>{u(`/delivery/order/${s}`)},c=g.filter(s=>!s.is_rejected&&!s.marked_delivered_at&&(s.orders.status==="pending"||s.orders.status==="confirmed")),m=g.filter(s=>!s.is_rejected&&!s.marked_delivered_at&&s.orders.status==="out_for_delivery"),w=g.filter(s=>!s.is_rejected&&s.marked_delivered_at&&!s.user_confirmed_at),o=g.filter(s=>s.user_confirmed_at),q=g.filter(s=>s.is_rejected),f=l.useMemo(()=>{const s=new Date,t=new Date(s);t.setHours(0,0,0,0);const r=new Date(s);r.setDate(r.getDate()-7),r.setHours(0,0,0,0);const n=new Date(s);n.setMonth(n.getMonth()-1),n.setHours(0,0,0,0);const d=o.filter(a=>a.user_confirmed_at&&new Date(a.user_confirmed_at)>=t).length;let i=o;return h==="today"?i=o.filter(a=>a.user_confirmed_at&&new Date(a.user_confirmed_at)>=t):h==="week"?i=o.filter(a=>a.user_confirmed_at&&new Date(a.user_confirmed_at)>=r):h==="month"&&(i=o.filter(a=>a.user_confirmed_at&&new Date(a.user_confirmed_at)>=n)),{today:d,delivered:o.length,earnings:i.length*5,earningsCount:i.length,pending:c.length+m.length}},[o,c,m,h]),Q=({createdAt:s})=>{const{timeString:t,color:r,isExpired:n}=G(s),d={green:"bg-emerald-100 text-emerald-700",yellow:"bg-amber-100 text-amber-700",red:"bg-red-100 text-red-700 animate-pulse"};return e.jsxs("div",{className:`flex items-center gap-1 px-2 py-0.5 rounded-full text-[10px] font-mono font-bold ${d[r]}`,children:[e.jsx(me,{className:"w-3 h-3"}),n?"LATE":t]})},_=({a:s,type:t})=>e.jsx(j,{className:"mb-3 border border-border/40 cursor-pointer hover:shadow-md transition-shadow",onClick:()=>K(s.order_id),children:e.jsxs(b,{className:"p-4",children:[e.jsxs("div",{className:"flex justify-between items-start mb-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("p",{className:"font-bold text-foreground",children:["Order ",s.orderNumber]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:re(new Date(s.orders.created_at),"hh:mm a")})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[(t==="new"||t==="transit")&&e.jsx(Q,{createdAt:s.orders.created_at}),e.jsxs(ae,{className:"bg-primary text-primary-foreground",children:["₹",s.orders.total_amount]})]})]}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsxs("div",{className:"flex-1 flex items-start gap-2 p-2 bg-muted rounded-lg",children:[e.jsx(ne,{className:"w-4 h-4 text-primary shrink-0 mt-0.5"}),e.jsx("p",{className:"text-xs text-foreground leading-tight line-clamp-2",children:s.orders.delivery_address})]}),e.jsx(C,{size:"icon",className:"h-10 w-10 bg-primary hover:bg-primary/90",onClick:r=>J(r,s.orders.delivery_address),children:e.jsx(ce,{className:"w-4 h-4"})})]}),t==="new"&&e.jsxs(C,{className:"w-full bg-primary hover:bg-primary/90",onClick:r=>V(r,s.id,s.order_id),disabled:N===s.id,children:[e.jsx(I,{className:"w-4 h-4 mr-2"}),N===s.id?"Picking...":"Pick Up"]}),t==="transit"&&e.jsxs(C,{className:"w-full bg-primary hover:bg-primary/90",onClick:r=>W(r,s.id),disabled:N===s.id,children:[e.jsx(ie,{className:"w-4 h-4 mr-2"}),N===s.id?"Marking...":"Mark Delivered"]}),t==="await"&&e.jsxs("div",{className:"flex items-center justify-between p-2 bg-secondary rounded-lg",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"Pending confirmation"}),e.jsx($,{className:"w-4 h-4 text-muted-foreground"})]}),t==="done"&&e.jsxs("div",{className:"flex items-center justify-between p-2 bg-primary/10 rounded-lg",children:[e.jsx("span",{className:"text-xs text-primary font-medium",children:"Delivered"}),e.jsx($,{className:"w-4 h-4 text-primary"})]}),t==="rejected"&&e.jsxs("div",{className:"flex items-center justify-between p-2 bg-destructive/10 rounded-lg",children:[e.jsx("span",{className:"text-xs text-destructive font-medium",children:"Rejected"}),e.jsx($,{className:"w-4 h-4 text-destructive"})]})]})}),k=({text:s})=>e.jsxs("div",{className:"text-center py-12",children:[e.jsx(de,{className:"w-10 h-10 mx-auto mb-2 text-muted-foreground opacity-50"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s})]});return F?e.jsxs("div",{className:"min-h-screen bg-background p-4",children:[e.jsx(D,{className:"h-14 w-full mb-4 rounded-xl"}),e.jsx("div",{className:"grid grid-cols-3 gap-3 mb-4",children:[1,2,3].map(s=>e.jsx(D,{className:"h-16 rounded-xl"},s))}),e.jsx(D,{className:"h-10 w-full mb-4"}),[1,2].map(s=>e.jsx(D,{className:"h-32 w-full mb-3 rounded-xl"},s))]}):e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-primary/5 via-background to-accent/5",children:[e.jsx("header",{className:"sticky top-0 z-50 border-b border-border/40 bg-background/80 backdrop-blur-xl",children:e.jsxs("div",{className:"flex items-center justify-between px-4 py-3",children:[e.jsx(C,{variant:"ghost",size:"icon",className:"h-10 w-10 rounded-full bg-primary/10 hover:bg-primary/20",onClick:()=>u("/delivery/profile"),children:e.jsx(te,{className:"h-5 w-5 text-primary"})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-8 rounded-lg bg-primary flex items-center justify-center",children:e.jsx(I,{className:"w-4 h-4 text-primary-foreground"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"font-bold text-base",children:"Delivery"}),e.jsxs("p",{className:"text-[10px] text-muted-foreground",children:[P," min limit"]})]})]}),e.jsx("div",{className:"w-10"})," "]})}),e.jsxs("div",{className:"grid grid-cols-4 gap-2 p-3",children:[e.jsx(j,{className:"border-0 bg-primary/10",children:e.jsxs(b,{className:"p-2 text-center",children:[e.jsx("p",{className:"text-lg font-bold",children:f.pending}),e.jsx("p",{className:"text-[9px] text-muted-foreground",children:"Pending"})]})}),e.jsx(j,{className:"border-0 bg-primary/10",children:e.jsxs(b,{className:"p-2 text-center",children:[e.jsxs("p",{className:"text-lg font-bold text-primary",children:["₹",f.earnings]}),e.jsx("p",{className:"text-[9px] text-muted-foreground",children:"Earned"})]})}),e.jsx(j,{className:"border-0 bg-primary/10",children:e.jsxs(b,{className:"p-2 text-center",children:[e.jsx("p",{className:"text-lg font-bold",children:f.today}),e.jsx("p",{className:"text-[9px] text-muted-foreground",children:"Delivered"})]})}),e.jsx(j,{className:"border-0 bg-secondary",children:e.jsxs(b,{className:"p-2 text-center",children:[e.jsx("p",{className:"text-lg font-bold",children:f.delivered}),e.jsx("p",{className:"text-[9px] text-muted-foreground",children:"Orders"})]})})]}),e.jsxs("div",{className:"px-3 pb-2 flex items-center gap-2",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"Earnings period:"}),e.jsxs("select",{value:h,onChange:s=>z(s.target.value),className:"text-xs rounded-md border border-border bg-background px-2 py-1",children:[e.jsx("option",{value:"today",children:"Today"}),e.jsx("option",{value:"week",children:"This Week"}),e.jsx("option",{value:"month",children:"This Month"}),e.jsx("option",{value:"all",children:"All Time"})]}),e.jsxs("span",{className:"text-xs text-muted-foreground ml-auto",children:[f.earningsCount," × ₹5"]})]}),e.jsx("div",{className:"px-3 pb-6",children:e.jsxs(le,{defaultValue:"new",children:[e.jsxs(oe,{className:"w-full grid grid-cols-4 h-9 mb-3 bg-muted",children:[e.jsxs(M,{value:"new",className:"text-[10px] data-[state=active]:bg-primary data-[state=active]:text-primary-foreground",children:["New",c.length>0&&` (${c.length})`]}),e.jsxs(M,{value:"transit",className:"text-[10px] data-[state=active]:bg-primary data-[state=active]:text-primary-foreground",children:["Transit",m.length>0&&` (${m.length})`]}),e.jsxs(M,{value:"await",className:"text-[10px] data-[state=active]:bg-primary data-[state=active]:text-primary-foreground",children:["Await",w.length>0&&` (${w.length})`]}),e.jsx(M,{value:"rejected",className:"text-[10px] data-[state=active]:bg-destructive data-[state=active]:text-white",children:"Reject"})]}),e.jsx(E,{value:"new",children:c.length===0?e.jsx(k,{text:"No new orders"}):c.map(s=>e.jsx(_,{a:s,type:"new"},s.id))}),e.jsx(E,{value:"transit",children:m.length===0?e.jsx(k,{text:"No orders in transit"}):m.map(s=>e.jsx(_,{a:s,type:"transit"},s.id))}),e.jsx(E,{value:"await",children:w.length===0?e.jsx(k,{text:"No pending confirmations"}):w.map(s=>e.jsx(_,{a:s,type:"await"},s.id))}),e.jsx(E,{value:"rejected",children:q.length===0?e.jsx(k,{text:"No rejected orders"}):q.map(s=>e.jsx(_,{a:s,type:"rejected"},s.id))})]})})]})}export{fe as default};
