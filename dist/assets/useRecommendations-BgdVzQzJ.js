import{u as J,r as _,s as m,l as A}from"./index-DxtDyefn.js";let h=null,g=!1;function Q(){const{user:u}=J(),[B,M]=_.useState([]),[$,P]=_.useState([]),[j,k]=_.useState(!0),f=_.useRef(!0),H=o=>{let r=0;for(let c=0;c<o.length;c++){const y=o.charCodeAt(c);r=(r<<5)-r+y,r=r&r}return Math.abs(r)},E=_.useCallback(o=>{const r=u?`${u.id}-${new Date().toDateString()}`:new Date().toDateString();return H(`${r}-${o}`)%100/100*2},[u]),L=_.useCallback(async o=>{if(u&&h!==!1)try{const{data:r,error:c}=await m.from("user_product_views").select("id, view_count").eq("user_id",u.id).eq("product_id",o).maybeSingle();if(c&&!g){A.debug("user_product_views table check failed",{error:c}),h=!1,g=!0;return}h=!0,g=!0,r?await m.from("user_product_views").update({view_count:(r.view_count||1)+1,last_viewed_at:new Date().toISOString()}).eq("id",r.id):await m.from("user_product_views").insert({user_id:u.id,product_id:o,view_count:1,first_viewed_at:new Date().toISOString(),last_viewed_at:new Date().toISOString()})}catch{g||(h=!1,g=!0)}},[u]),T=_.useCallback(async()=>{const o=new Map;try{const r=new Date(Date.now()-6048e5).toISOString(),{data:c}=await m.from("order_items").select("product_id, quantity, created_at").gte("created_at",r);if(c){const w=Date.now();c.forEach(n=>{const v=new Date(n.created_at||Date.now()).getTime(),D=(w-v)/(1e3*60*60*24),l=Math.exp(-D/7),S=o.get(n.product_id)||0,q=l*(.7+.3*Math.min(n.quantity/5,1));o.set(n.product_id,S+q)})}const y=Math.max(...Array.from(o.values()),1);o.forEach((w,n)=>{o.set(n,w/y*20)})}catch(r){A.debug("Trending calculation failed",{error:r})}return o},[]),I=_.useCallback(async()=>{try{const{data:o}=await m.from("products").select("*").eq("is_active",!0).gt("stock_quantity",0).order("created_at",{ascending:!1});if(!o||o.length===0){f.current&&k(!1);return}const r=o,c=r.map(e=>e.id),{data:y}=await m.from("product_variants").select("*").in("product_id",c).eq("is_default",!0),w=r.map(e=>{const t=(y==null?void 0:y.find(s=>s.product_id===e.id))||null;return{...e,default_variant:t}});if(!f.current)return;const n=await T();if(!u){const e=[...w].sort((t,s)=>{const a=n.get(t.id)||0,i=n.get(s.id)||0;return i===a?t.id.localeCompare(s.id):i-a});f.current&&(P(e.slice(0,10)),M([]),k(!1));return}let v=[];if(h!==!1)try{const{data:e,error:t}=await m.from("user_product_views").select("product_id, view_count, last_viewed_at").eq("user_id",u.id).order("last_viewed_at",{ascending:!1}).limit(50);!t&&e?(v=e,h=!0):g||(h=!1),g=!0}catch{g||(h=!1,g=!0)}if(!f.current)return;const{data:D}=await m.from("orders").select(`
                    id,
                    created_at,
                    order_items(product_id, products(category_id))
                `).eq("user_id",u.id).eq("status","delivered").order("created_at",{ascending:!1}).limit(30);if(!f.current)return;const l={},S=new Set,q=new Date(Date.now()-14*24*60*60*1e3);D&&D.forEach(e=>{var s;const t=new Date(e.created_at||Date.now());(s=e.order_items)==null||s.forEach(a=>{var d;const i=(d=a.products)==null?void 0:d.category_id;if(i){const p=(Date.now()-t.getTime())/864e5,C=Math.exp(-p/30);l[i]=(l[i]||0)+35*C}t>q&&S.add(a.product_id)})});const O={};v&&Array.isArray(v)&&v.forEach((e,t)=>{const s=Math.exp(-t/20),a=e.view_count??1,i=Math.min(a*5*s,25);O[e.product_id]=i;const d=w.find(p=>p.id===e.product_id);d!=null&&d.category_id&&(l[d.category_id]=(l[d.category_id]||0)+a*2*s)});const V=Math.max(...Object.values(l),1);Object.keys(l).forEach(e=>{l[e]=l[e]/V*35});const z=w.map(e=>{if(S.has(e.id))return{product:e,score:-1,reasons:["recently_purchased"],scoreBreakdown:{}};let t=0;const s=[],a={},i=e.category_id&&l[e.category_id]||0;i>0&&(t+=i,a.category=i,s.push("category_match"));const d=O[e.id]||0;d>0&&(t+=d,a.views=d,s.push("viewed"));const p=n.get(e.id)||0;t+=p,a.trending=p,p>5&&s.push("trending");const C=Date.now()-new Date(e.created_at||0).getTime();let b=0;C<7*24*60*60*1e3?(b=10,s.push("new")):C<14*24*60*60*1e3&&(b=5),t+=b,a.freshness=b;const R=E(e.id);return t+=R,a.random=R,t>30&&A.debug("Product recommendation scored",{product_id:e.id,product_name:e.name,reasons:s,score_breakdown:a,total_score:t}),{product:e,score:t,reasons:s,scoreBreakdown:a}}).filter(e=>e.score>=0).sort((e,t)=>t.score!==e.score?t.score-e.score:e.product.id.localeCompare(t.product.id)),x={},F=4,W=z.filter(({product:e})=>{const t=e.category_id||"uncategorized";return x[t]=(x[t]||0)+1,x[t]<=F}).slice(0,12);f.current&&M(W.map(e=>e.product));const G=[...w].filter(e=>!S.has(e.id)).sort((e,t)=>{const s=n.get(e.id)||0,a=n.get(t.id)||0;return a!==s?a-s:e.id.localeCompare(t.id)}).slice(0,8);f.current&&P(G)}catch(o){A.error("Recommendations error",{error:o})}finally{f.current&&k(!1)}},[u,T,E]);return _.useEffect(()=>(f.current=!0,I(),()=>{f.current=!1}),[I]),{recommendedProducts:B,trendingProducts:$,isLoading:j,trackView:L}}export{Q as u};
